import{_ as i,c as a,o as n,ag as p}from"./chunks/framework.BDwTZuFy.js";const d=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"131. 会议室预定系统：用 migration 初始化表和数据.md","filePath":"131. 会议室预定系统：用 migration 初始化表和数据.md"}'),t={name:"131. 会议室预定系统：用 migration 初始化表和数据.md"};function h(l,s,e,k,r,E){return n(),a("div",null,s[0]||(s[0]=[p(`<p>前几节我们把项目部署到了阿里云，能够在全球各地通过 ip 来访问了。</p><p>方式是在服务器上通过 git 下载代码，然后用 docker compose 来跑。</p><p>但我们并没有把 typeorm 的 synchronize 关掉，也就是现在还是根据 entity 自动创建表的方式。</p><p>这种方式并不安全，entity 一改表结构就自动跟着改，容易丢数据。</p><p>在生产环境应该把 synchronize 关掉，然后用 migration 来管理创建表、数据初始化、表结构修改等操作。</p><p>这节我们来做一下：</p><p>首先，我们在 mysql workbench 里把现有的数据导出。</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-1.png" alt="" loading="lazy"></p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-2.png" alt="" loading="lazy"></p><p>这样每个表一个 sql 文件：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-3.png" alt="" loading="lazy"></p><p>我们选择第二个选项，重新导出下：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-4.png" alt="" loading="lazy"></p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-5.png" alt="" loading="lazy"></p><p>这样就都集中到一个 sql 文件里了。</p><p>打开这个生成的 sql 文件看下：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-6.png" alt="" loading="lazy"></p><p>包含了所有的表的 create table 和 insert into 语句。</p><p>然后我们在项目的 package.json 里加一下 migration 的 npm scripts：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-7.png" alt="" loading="lazy"></p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;typeorm&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ts-node ./node_modules/typeorm/cli&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;migration:create&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;npm run typeorm -- migration:create&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;migration:generate&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;npm run typeorm -- migration:generate -d ./src/data-source.ts&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;migration:run&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;npm run typeorm -- migration:run -d ./src/data-source.ts&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;migration:revert&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;npm run typeorm -- migration:revert -d ./src/data-source.ts&quot;</span></span></code></pre></div><p>migration 需要单独一个 data-source.ts 文件。</p><p>创建下 src/data-source.ts</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { DataSource } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;typeorm&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { config } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;dotenv&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { Permission } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./user/entities/permission.entity&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { Role } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./user/entities/role.entity&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { User } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./user/entities/user.entity&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { MeetingRoom } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;./meeting-room/entities/meeting-room.entity&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { Booking } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;./booking/entities/booking.entity&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ path: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;src/.env-migration&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(process.env);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mysql&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    host: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">process</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">env</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mysql_server_host</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    port: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">process</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">env</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mysql_server_port</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    username: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">process</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">env</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mysql_server_username</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    password: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">process</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">env</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mysql_server_password</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    database: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">process</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">env</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mysql_server_database</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    synchronize: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    logging: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    entities: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      User, Role, Permission, MeetingRoom, Booking</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    poolSize: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    migrations: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;src/migrations/**.ts&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    connectorPackage: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;mysql2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    extra: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        authPlugin: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;sha256_password&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><p>synchronize 指定为 false，顺便把 AppModule 里的 synchronize 也改为 false。</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-8.png" alt="" loading="lazy"></p><p>我们创建个单独的 .env-migration 文件：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mysql_server_host</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">localhost</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mysql_server_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3306</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mysql_server_username</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">root</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mysql_server_password</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">guang</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mysql_server_database</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">meeting_room_booking_system</span></span></code></pre></div><p>因为 .env 里配置的 host 是容器名，那个只对 docker compose 内部生效：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-9.png" alt="" loading="lazy"></p><p>而 migration 的时候我们是需要真实的 host 的地址的，所以单独搞一个 .env 文件来配置。</p><p>跑下 migration:generate 试试：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>npm run migration:generate src/migrations/init</span></span></code></pre></div><p>如果遇到找不到 entity 的错误，把绝对路径改为相对路径就好了：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-10.png" alt="" loading="lazy"></p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-11.png" alt="" loading="lazy"></p><p>这时候没什么更改：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-12.png" alt="" loading="lazy"></p><p>因为 entity 和数据库表是同步的。</p><p>我们把数据表给删掉：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-13.png" alt="" loading="lazy"></p><p>再跑下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>npm run migration:generate src/migrations/init</span></span></code></pre></div><p>这时候就成功生成了迁移代码：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-14.png" alt="" loading="lazy"></p><p>里面包含的自然就是所有表的 create table 语句：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-15.png" alt="" loading="lazy"></p><p>跑下这个迁移：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>npm run migration:run</span></span></code></pre></div><p>可以看到，所有 create table 语句都执行了：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-16.png" alt="" loading="lazy"></p><p>数据库里也有了这些表：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-17.png" alt="" loading="lazy"></p><p>并且在 migrations 表里记录了这个 migration 的执行记录：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-18.png" alt="" loading="lazy"></p><p>表创建好了，还要做初始化数据。</p><p>我们同样通过 migration 来做，但是这个是没法 generate 的，generate 只会对比表结构，然后生成迁移 sql。</p><p>执行 create 生成 migration 类：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>npm run migration:create src/migrations/data</span></span></code></pre></div><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-19.png" alt="" loading="lazy"></p><p>这次我们自己来填 sql：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-20.png" alt="" loading="lazy"></p><p>之前导出的 sql 文件现在就有用了。</p><p>把里面的 insert into 语句复制出来：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { MigrationInterface, QueryRunner } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;typeorm&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Data1718869390167</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MigrationInterface</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> up</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">queryRunner</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> QueryRunner</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queryRunner.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;INSERT INTO \`booking\` VALUES (1,&#39;2023-09-29 10:54:01&#39;,&#39;2023-09-29 11:54:01&#39;,&#39;审批通过&#39;,&#39;&#39;,1,3,&#39;2023-09-29 03:06:54.088220&#39;,&#39;2023-11-17 01:58:53.000000&#39;),(2,&#39;2023-09-29 10:54:02&#39;,&#39;2023-09-29 11:54:02&#39;,&#39;审批驳回&#39;,&#39;&#39;,2,6,&#39;2023-09-29 03:06:54.088220&#39;,&#39;2023-10-21 03:42:53.000000&#39;),(3,&#39;2023-09-29 11:54:02&#39;,&#39;2023-09-29 12:54:02&#39;,&#39;已解除&#39;,&#39;&#39;,2,3,&#39;2023-09-29 03:06:54.088220&#39;,&#39;2023-11-19 01:10:49.741279&#39;),(4,&#39;2023-09-29 10:54:02&#39;,&#39;2023-09-29 11:54:02&#39;,&#39;审批通过&#39;,&#39;&#39;,1,6,&#39;2023-09-29 03:06:54.088220&#39;,&#39;2023-11-19 02:30:58.000000&#39;),(5,&#39;2023-09-29 10:54:02&#39;,&#39;2023-09-29 11:54:02&#39;,&#39;审批通过&#39;,&#39;&#39;,8,11,&#39;2023-09-29 03:06:54.088220&#39;,&#39;2023-11-19 02:30:58.000000&#39;),(6,&#39;2023-09-29 10:54:02&#39;,&#39;2023-09-29 11:54:02&#39;,&#39;已解除&#39;,&#39;&#39;,9,11,&#39;2023-09-29 03:06:54.088220&#39;,&#39;2024-01-01 01:23:53.000000&#39;),(7,&#39;2023-09-29 10:54:02&#39;,&#39;2023-09-29 11:54:02&#39;,&#39;审批通过&#39;,&#39;&#39;,9,3,&#39;2023-09-29 03:06:54.088220&#39;,&#39;2024-01-01 01:10:14.279639&#39;),(8,&#39;2023-09-29 10:54:02&#39;,&#39;2023-09-29 11:54:02&#39;,&#39;审批通过&#39;,&#39;&#39;,9,6,&#39;2023-09-29 03:06:54.088220&#39;,&#39;2024-01-01 01:19:23.388907&#39;),(13,&#39;2023-12-31 09:40:59&#39;,&#39;2023-12-31 09:57:39&#39;,&#39;申请中&#39;,&#39;&#39;,1,11,&#39;2023-12-31 04:34:38.917720&#39;,&#39;2024-01-01 01:08:53.884596&#39;),(14,&#39;2023-12-31 09:42:39&#39;,&#39;2023-12-31 10:14:19&#39;,&#39;申请中&#39;,&#39;&#39;,1,6,&#39;2023-12-31 04:35:06.508185&#39;,&#39;2024-01-01 01:08:04.023433&#39;),(15,&#39;2024-01-01 11:00:00&#39;,&#39;2024-01-01 12:00:00&#39;,&#39;申请中&#39;,&#39;&#39;,1,3,&#39;2024-01-01 02:43:26.920016&#39;,&#39;2024-01-01 02:43:26.920016&#39;),(16,&#39;2024-01-01 13:00:00&#39;,&#39;2024-01-01 14:00:00&#39;,&#39;申请中&#39;,&#39;&#39;,1,3,&#39;2024-01-01 02:45:47.758012&#39;,&#39;2024-01-01 02:45:47.758012&#39;),(17,&#39;2024-01-01 15:00:00&#39;,&#39;2024-01-01 16:00:00&#39;,&#39;申请中&#39;,&#39;&#39;,1,3,&#39;2024-01-01 02:46:39.654219&#39;,&#39;2024-01-01 02:46:39.654219&#39;);&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queryRunner.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;INSERT INTO \`meeting_room\` VALUES (3,&#39;天王星33&#39;,30,&#39;三层东&#39;,&#39;白板，电视&#39;,&#39;&#39;,0,&#39;2023-09-16 08:10:25.319000&#39;,&#39;2023-09-16 08:10:25.319000&#39;),(6,&#39;aa&#39;,10,&#39;bb&#39;,&#39;&#39;,&#39;&#39;,0,&#39;2023-09-16 16:11:31.532151&#39;,&#39;2023-09-16 16:11:31.532151&#39;),(11,&#39;xxx&#39;,0,&#39;xxx&#39;,&#39;xxx&#39;,&#39;xxx&#39;,0,&#39;2023-09-28 00:27:28.529606&#39;,&#39;2023-09-28 00:27:28.529606&#39;),(12,&#39;aaa&#39;,0,&#39;xxx&#39;,&#39;xxx&#39;,&#39;xxx&#39;,0,&#39;2023-09-28 00:28:09.291785&#39;,&#39;2023-09-28 00:28:09.291785&#39;);&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queryRunner.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;INSERT INTO \`permissions\` VALUES (7,&#39;ccc&#39;,&#39;访问 ccc 接口&#39;),(8,&#39;ddd&#39;,&#39;访问 ddd 接口&#39;);&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queryRunner.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;INSERT INTO \`role_permissions\` VALUES (7,7),(7,8),(8,7);&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queryRunner.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;INSERT INTO \`roles\` VALUES (7,&#39;管理员&#39;),(8,&#39;普通用户&#39;);&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queryRunner.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;INSERT INTO \`user_roles\` VALUES (8,7),(9,8);&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queryRunner.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;INSERT INTO \`users\` VALUES (1,&#39;guang&#39;,&#39;e10adc3949ba59abbe56e057f20f883e&#39;,&#39;神说要有光&#39;,&#39;xxxx@xx.com&#39;,NULL,NULL,1,0,&#39;2023-07-25 02:25:03.379725&#39;,&#39;2023-09-12 03:40:40.000000&#39;),(2,&#39;guang2&#39;,&#39;e10adc3949ba59abbe56e057f20f883e&#39;,&#39;神说要有光2&#39;,&#39;1024195375@qq.com&#39;,NULL,NULL,1,0,&#39;2023-07-26 01:39:33.456072&#39;,&#39;2023-09-12 03:57:06.000000&#39;),(8,&#39;zhangsan&#39;,&#39;e3ceb5881a0a1fdaad01296d7554868d&#39;,&#39;张三&#39;,&#39;1024195375@qq.com&#39;,&#39;uploads/1694845395657-974488092-headpic1.png&#39;,&#39;13233323333&#39;,1,1,&#39;2023-07-26 03:19:06.523236&#39;,&#39;2023-09-16 06:59:32.000000&#39;),(9,&#39;lisi&#39;,&#39;1a100d2c0dab19c4430e7d73762b3423&#39;,&#39;里斯&#39;,&#39;yy@yy.com&#39;,&#39;xxx.png&#39;,NULL,1,0,&#39;2023-07-26 03:19:06.553169&#39;,&#39;2023-08-02 13:05:53.000000&#39;),(10,&#39;dongdong&#39;,&#39;1a100d2c0dab19c4430e7d73762b3423&#39;,&#39;东东555&#39;,&#39;1024195375@qq.com&#39;,&#39;uploads/1692775078275-227950493-headpic2.png&#39;,NULL,1,0,&#39;2023-08-12 15:41:10.537642&#39;,&#39;2023-09-12 04:01:41.000000&#39;),(11,&#39;gang&#39;,&#39;96e79218965eb72c92a549dd5a330112&#39;,&#39;小刚&#39;,&#39;1024195375@qq.com&#39;,NULL,NULL,1,0,&#39;2023-08-12 23:54:38.856096&#39;,&#39;2023-09-12 03:50:45.000000&#39;),(12,&#39;xiaohong&#39;,&#39;96e79218965eb72c92a549dd5a330112&#39;,&#39;小红&#39;,&#39;1024195375@qq.com&#39;,NULL,NULL,0,0,&#39;2023-08-13 00:00:53.802850&#39;,&#39;2023-09-12 03:54:32.846920&#39;),(13,&#39;xiaodong&#39;,&#39;96e79218965eb72c92a549dd5a330112&#39;,&#39;东东&#39;,&#39;1024195375@qq.com&#39;,NULL,NULL,1,0,&#39;2023-08-13 00:01:52.641836&#39;,&#39;2023-09-12 03:53:09.000000&#39;);&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> down</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">queryRunner</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> QueryRunner</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queryRunner.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;TRUNCATE TABLE booking&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>这里要用你自己的 sql。</p><p>然后 down 部分如果你想 revert 的话也可以写一下，就是 insert into 的反义词 delete from，或者直接 truncate table 清空数据。</p><p>跑一下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>npm run migration:run</span></span></code></pre></div><p>这一步有可能报错：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-21.png" alt="" loading="lazy"></p><p>也就是列的顺序对不上。</p><p>因为 sql 文件里的顺序是这样的：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-22.png" alt="" loading="lazy"></p><p>第 6、7 列是 userId、roomId，和 insert into 语句对应。</p><p>而现在第 6 列是 createTime：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-23.png" alt="" loading="lazy"></p><p>所以就报了上面的错误。</p><p>这个问题的解决也简单，insert into 的时候指定列名就好了。</p><p>右键表，选择复制 insert into 语句：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-24.png" alt="" loading="lazy"></p><p>在输入框粘贴下：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-25.png" alt="" loading="lazy"></p><p>把列名这部分复制出来，调整成正确的顺序然后放到 insert into 的 sql 里：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-26.png" alt="" loading="lazy"></p><p>只有这一个有问题的 insert 语句指定下列名就行，别的 insert 语句不用改。</p><p>然后你还可能遇到外键约束的问题：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-27.png" alt="" loading="lazy"></p><p>就是你插入了一条 booking 记录，里面的 userId 在 user 表里没关联的 user。</p><p>这种调整下插入顺序就好了，先插入 user 表，再插入 booking 表。</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { MigrationInterface, QueryRunner } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;typeorm&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Data1718869390167</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MigrationInterface</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> up</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">queryRunner</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> QueryRunner</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queryRunner.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;INSERT INTO \`booking\`(\`id\`,\`startTime\`,\`endTime\`,\`status\`,\`note\`,\`userId\`,\`roomId\`,\`createTime\`,\`updateTime\`) VALUES (1,&#39;2023-09-29 10:54:01&#39;,&#39;2023-09-29 11:54:01&#39;,&#39;审批通过&#39;,&#39;&#39;,1,3,&#39;2023-09-29 03:06:54.088220&#39;,&#39;2023-11-17 01:58:53.000000&#39;),(2,&#39;2023-09-29 10:54:02&#39;,&#39;2023-09-29 11:54:02&#39;,&#39;审批驳回&#39;,&#39;&#39;,2,6,&#39;2023-09-29 03:06:54.088220&#39;,&#39;2023-10-21 03:42:53.000000&#39;),(3,&#39;2023-09-29 11:54:02&#39;,&#39;2023-09-29 12:54:02&#39;,&#39;已解除&#39;,&#39;&#39;,2,3,&#39;2023-09-29 03:06:54.088220&#39;,&#39;2023-11-19 01:10:49.741279&#39;),(4,&#39;2023-09-29 10:54:02&#39;,&#39;2023-09-29 11:54:02&#39;,&#39;审批通过&#39;,&#39;&#39;,1,6,&#39;2023-09-29 03:06:54.088220&#39;,&#39;2023-11-19 02:30:58.000000&#39;),(5,&#39;2023-09-29 10:54:02&#39;,&#39;2023-09-29 11:54:02&#39;,&#39;审批通过&#39;,&#39;&#39;,8,11,&#39;2023-09-29 03:06:54.088220&#39;,&#39;2023-11-19 02:30:58.000000&#39;),(6,&#39;2023-09-29 10:54:02&#39;,&#39;2023-09-29 11:54:02&#39;,&#39;已解除&#39;,&#39;&#39;,9,11,&#39;2023-09-29 03:06:54.088220&#39;,&#39;2024-01-01 01:23:53.000000&#39;),(7,&#39;2023-09-29 10:54:02&#39;,&#39;2023-09-29 11:54:02&#39;,&#39;审批通过&#39;,&#39;&#39;,9,3,&#39;2023-09-29 03:06:54.088220&#39;,&#39;2024-01-01 01:10:14.279639&#39;),(8,&#39;2023-09-29 10:54:02&#39;,&#39;2023-09-29 11:54:02&#39;,&#39;审批通过&#39;,&#39;&#39;,9,6,&#39;2023-09-29 03:06:54.088220&#39;,&#39;2024-01-01 01:19:23.388907&#39;),(13,&#39;2023-12-31 09:40:59&#39;,&#39;2023-12-31 09:57:39&#39;,&#39;申请中&#39;,&#39;&#39;,1,11,&#39;2023-12-31 04:34:38.917720&#39;,&#39;2024-01-01 01:08:53.884596&#39;),(14,&#39;2023-12-31 09:42:39&#39;,&#39;2023-12-31 10:14:19&#39;,&#39;申请中&#39;,&#39;&#39;,1,6,&#39;2023-12-31 04:35:06.508185&#39;,&#39;2024-01-01 01:08:04.023433&#39;),(15,&#39;2024-01-01 11:00:00&#39;,&#39;2024-01-01 12:00:00&#39;,&#39;申请中&#39;,&#39;&#39;,1,3,&#39;2024-01-01 02:43:26.920016&#39;,&#39;2024-01-01 02:43:26.920016&#39;),(16,&#39;2024-01-01 13:00:00&#39;,&#39;2024-01-01 14:00:00&#39;,&#39;申请中&#39;,&#39;&#39;,1,3,&#39;2024-01-01 02:45:47.758012&#39;,&#39;2024-01-01 02:45:47.758012&#39;),(17,&#39;2024-01-01 15:00:00&#39;,&#39;2024-01-01 16:00:00&#39;,&#39;申请中&#39;,&#39;&#39;,1,3,&#39;2024-01-01 02:46:39.654219&#39;,&#39;2024-01-01 02:46:39.654219&#39;);&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queryRunner.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;INSERT INTO \`users\` VALUES (1,&#39;guang&#39;,&#39;e10adc3949ba59abbe56e057f20f883e&#39;,&#39;神说要有光&#39;,&#39;xxxx@xx.com&#39;,NULL,NULL,1,0,&#39;2023-07-25 02:25:03.379725&#39;,&#39;2023-09-12 03:40:40.000000&#39;),(2,&#39;guang2&#39;,&#39;e10adc3949ba59abbe56e057f20f883e&#39;,&#39;神说要有光2&#39;,&#39;1024195375@qq.com&#39;,NULL,NULL,1,0,&#39;2023-07-26 01:39:33.456072&#39;,&#39;2023-09-12 03:57:06.000000&#39;),(8,&#39;zhangsan&#39;,&#39;e3ceb5881a0a1fdaad01296d7554868d&#39;,&#39;张三&#39;,&#39;1024195375@qq.com&#39;,&#39;uploads/1694845395657-974488092-headpic1.png&#39;,&#39;13233323333&#39;,1,1,&#39;2023-07-26 03:19:06.523236&#39;,&#39;2023-09-16 06:59:32.000000&#39;),(9,&#39;lisi&#39;,&#39;1a100d2c0dab19c4430e7d73762b3423&#39;,&#39;里斯&#39;,&#39;yy@yy.com&#39;,&#39;xxx.png&#39;,NULL,1,0,&#39;2023-07-26 03:19:06.553169&#39;,&#39;2023-08-02 13:05:53.000000&#39;),(10,&#39;dongdong&#39;,&#39;1a100d2c0dab19c4430e7d73762b3423&#39;,&#39;东东555&#39;,&#39;1024195375@qq.com&#39;,&#39;uploads/1692775078275-227950493-headpic2.png&#39;,NULL,1,0,&#39;2023-08-12 15:41:10.537642&#39;,&#39;2023-09-12 04:01:41.000000&#39;),(11,&#39;gang&#39;,&#39;96e79218965eb72c92a549dd5a330112&#39;,&#39;小刚&#39;,&#39;1024195375@qq.com&#39;,NULL,NULL,1,0,&#39;2023-08-12 23:54:38.856096&#39;,&#39;2023-09-12 03:50:45.000000&#39;),(12,&#39;xiaohong&#39;,&#39;96e79218965eb72c92a549dd5a330112&#39;,&#39;小红&#39;,&#39;1024195375@qq.com&#39;,NULL,NULL,0,0,&#39;2023-08-13 00:00:53.802850&#39;,&#39;2023-09-12 03:54:32.846920&#39;),(13,&#39;xiaodong&#39;,&#39;96e79218965eb72c92a549dd5a330112&#39;,&#39;东东&#39;,&#39;1024195375@qq.com&#39;,NULL,NULL,1,0,&#39;2023-08-13 00:01:52.641836&#39;,&#39;2023-09-12 03:53:09.000000&#39;);&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queryRunner.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;INSERT INTO \`meeting_room\` VALUES (3,&#39;天王星33&#39;,30,&#39;三层东&#39;,&#39;白板，电视&#39;,&#39;&#39;,0,&#39;2023-09-16 08:10:25.319000&#39;,&#39;2023-09-16 08:10:25.319000&#39;),(6,&#39;aa&#39;,10,&#39;bb&#39;,&#39;&#39;,&#39;&#39;,0,&#39;2023-09-16 16:11:31.532151&#39;,&#39;2023-09-16 16:11:31.532151&#39;),(11,&#39;xxx&#39;,0,&#39;xxx&#39;,&#39;xxx&#39;,&#39;xxx&#39;,0,&#39;2023-09-28 00:27:28.529606&#39;,&#39;2023-09-28 00:27:28.529606&#39;),(12,&#39;aaa&#39;,0,&#39;xxx&#39;,&#39;xxx&#39;,&#39;xxx&#39;,0,&#39;2023-09-28 00:28:09.291785&#39;,&#39;2023-09-28 00:28:09.291785&#39;);&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queryRunner.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;INSERT INTO \`permissions\` VALUES (7,&#39;ccc&#39;,&#39;访问 ccc 接口&#39;),(8,&#39;ddd&#39;,&#39;访问 ddd 接口&#39;);&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queryRunner.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;INSERT INTO \`roles\` VALUES (7,&#39;管理员&#39;),(8,&#39;普通用户&#39;);&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queryRunner.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;INSERT INTO \`role_permissions\` VALUES (7,7),(7,8),(8,7);&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queryRunner.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;INSERT INTO \`user_roles\` VALUES (8,7),(9,8);&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> down</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">queryRunner</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> QueryRunner</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> queryRunner.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;TRUNCATE TABLE booking&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>调整完再跑：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>npm run migration:run</span></span></code></pre></div><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-28.png" alt="" loading="lazy"></p><p>执行成功了！</p><p>在数据库看下：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-29.png" alt="" loading="lazy"></p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-30.png" alt="" loading="lazy"></p><p>数据都插入成功了，并且 migrations 表也记录了这次的执行记录：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/131-31.png" alt="" loading="lazy"></p><p>这样之后，生产环境就有表、也有数据了，之后就可以正常跑 Nest 应用了。</p><p>代码在<a href="https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/meeting_room_booking_system_backend" target="_blank" rel="noreferrer">小册仓库</a>。</p><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><p>这节我们实现了 migration 数据迁移，也就是创建表、初始化数据。</p><p>在生产环境会把 synchronize 关掉，然后跑 migration。</p><p>我们用 migration:generate 生成了 create table 的 migration。</p><p>然后用 migration:create 生成了空的 migration，填入了导出的 inert 语句。</p><p>执行完这两个 migration 之后，表和数据就都有了，就可以跑 Nest 项目了。</p><p>线上项目，都是这样用手动跑 migration 的方式来修改表的。</p>`,109)]))}const o=i(t,[["render",h]]);export{d as __pageData,o as default};
